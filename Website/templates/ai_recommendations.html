{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <a href="{{ url_for('views.home') }}" class="btn btn-outline-secondary mb-4">‚Üê Back to Dashboard</a>
    <h1 class="text-center text-dark mb-4">Smart Recommendations Assistant</h1>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg" style="height: 500px;">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span> AI Assistant</span>
                    <small>Online</small>
                </div>
                
                <div id="chat-window" class="card-body overflow-auto bg-light" style="flex: 1;">
                    <div class="d-flex flex-row justify-content-start mb-3">
                        <div class="p-3 bg-white border rounded shadow-sm" style="max-width: 75%;">
                            Hello! I can help you find rooms or check availability. Ask me something like "Is Lab 1 free?"
                        </div>
                    </div>
                    </div>

                <div class="card-footer">
                    <div class="input-group">
                        <input type="text" id="user-input" class="form-control" placeholder="Type your question..." onkeypress="handleEnter(event)">
                        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function sendMessage() {
        const inputField = document.getElementById('user-input');
        const chatWindow = document.getElementById('chat-window');
        const message = inputField.value.trim();

        if (message === "") return;

        // 1. Append User Message
        const userMsgDiv = document.createElement('div');
        userMsgDiv.className = "d-flex flex-row justify-content-end mb-3";
        userMsgDiv.innerHTML = `<div class="p-3 bg-primary text-white rounded shadow-sm" style="max-width: 75%;">${message}</div>`;
        chatWindow.appendChild(userMsgDiv);
        
        inputField.value = ""; // Clear input
        chatWindow.scrollTop = chatWindow.scrollHeight; // Auto scroll

        // 2. Send to Flask Backend
        try {
            const response = await fetch("{{ url_for('views.chatbot_api') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ message: message })
            });
            
            const data = await response.json();

            // 3. Append AI Response
            const aiMsgDiv = document.createElement('div');
            aiMsgDiv.className = "d-flex flex-row justify-content-start mb-3";
            aiMsgDiv.innerHTML = `<div class="p-3 bg-white border rounded shadow-sm" style="max-width: 75%;">${data.response}</div>`;
            chatWindow.appendChild(aiMsgDiv);
            
            chatWindow.scrollTop = chatWindow.scrollHeight;

        } catch (error) {
            console.error("Error:", error);
        }
    }

    function handleEnter(event) {
        if (event.key === "Enter") {
            sendMessage();
        }
    }
</script>
{% endblock %}